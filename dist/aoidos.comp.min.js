var Action=function(){function Action(data){this.id=data.id,this.alias=data.alias,this.cases=Case.parseList(data.cases)}return Action.prototype.matches=function(act){return this.id==act||-1!=this.alias.indexOf(act)},Action.prototype.run=function(){for(var i=0;i<this.cases.length;i++)if(this.cases[i].test())return console.log("Run Action: "+this.id),void this.cases[i].trigger()},Action.parseList=function(data){for(var actions=[],i=0;i<data.length;i++)actions.push(new Action(data[i]));return actions},Action}(),aoidos;$(document).ready(function(){$.ajaxSetup({cache:!1}),aoidos=new Aoidos("Mees Gelein","1.0.0"),$.getScript("data/custom.js",function(){console.log("Aoidos: Custom Functions loaded"),aoidos.init()})});var Aoidos=function(){function Aoidos(author,version){this.author=author,this.version=version,this.terminal=new Terminal,this.loader=new DataLoader("data/"),this.sound=new Sound,this.var=new Var,this.quest=new Var,console.log("Aoidos: Variable & Quest Registers loaded")}return Aoidos.prototype.init=function(){console.log("====================================="),console.log("Initialized Aoidos v."+this.version),console.log("All programming by "+this.author),console.log("Ready to load first room"),console.log("====================================="),Room.load("mainmenu")},Aoidos}(),Case=function(){function Case(data){this.lines=data.lines,this.conditions=Condition.parseList(data.conditions),this.triggers=Trigger.parseList(data.triggers)}return Case.prototype.test=function(){if(this.conditions.length>0)for(var i=0;i<this.conditions.length;i++)if(!this.conditions[i].test())return!1;return!0},Case.prototype.trigger=function(){aoidos.terminal.printlns(this.lines[Math.floor(Math.random()*this.lines.length)]);for(var i=0;i<this.triggers.length;i++)this.triggers[i].trigger()},Case.parseList=function(data){for(var cases=[],i=0;i<data.length;i++)cases.push(new Case(data[i]));return cases},Case}(),Condition=function(){function Condition(condition){this.stringDesc=condition}return Condition.prototype.test=function(){if(void 0==this.stringDesc||this.stringDesc.length<1)return!0;var firstLetter=this.stringDesc.substr(0,1).toUpperCase(),variables=this.stringDesc.substring(1).replace(/[()]/g,"");switch(firstLetter){case"Q":return this.testQuest(variables.split(",")[0].trim(),variables.split(",")[1].trim());case"V":return this.testVariable(variables.split(",")[0].trim(),variables.split(",")[1].trim());case"F":return this.testFunction(variables);case"R":return this.testRoom(variables);default:return console.log("Did not recognize condition register '"+firstLetter+"'"),!1}},Condition.prototype.testRoom=function(name){return Room.current.id===name},Condition.prototype.testFunction=function(name){return!0===aoidos_custom[name]()},Condition.prototype.testQuest=function(name,stage){return aoidos.quest.equals(name,Number(stage))},Condition.prototype.testVariable=function(name,value){switch(value.substring(0,1)){case">":return aoidos.var.greaterThan(name,Number(value.substring(1)));case"<":return aoidos.var.smallerThan(name,Number(value.substring(1)));default:return aoidos.var.equals(name,Number(value))}},Condition.parseList=function(data){for(var conditions=[],i=0;i<data.length;i++)conditions.push(new Condition(data[i]));return conditions},Condition}(),DataLoader=function(){function DataLoader(dataFolder){this.dataUrl=dataFolder,console.log("Aoidos: Dataloader ready for requests")}return DataLoader.prototype.load=function(url,callback){$.getJSON(this.dataUrl+url,function(data){callback(data)})},DataLoader.prototype.loadRoomData=function(id,room){this.load("rooms/"+id+"/room.json",function(data){Room.current=room,room.parseData(data)})},DataLoader.prototype.loadObjectData=function(id,obj){this.load(Room.current.getObjPath(id),function(data){obj.parseData(data)})},DataLoader}(),Lines=function(){function Lines(data){this.lines=data}return Lines.prototype.get=function(id){return this.lines[id].join("\n")},Lines}(),Obj=function(){function Obj(id){this.name=this.description="",this.alias=[],this.actions=[],this.id=id}return Obj.prototype.findAction=function(act){var actions=[];if(this.id==act)return this.actions;if(-1!=this.alias.indexOf(act))return this.actions;for(var i=0;i<this.actions.length;i++)this.actions[i].matches(act)&&actions.push(this.actions[i]);return actions},Obj.prototype.parseData=function(data){this.name=data.name,this.alias=data.alias,this.actions=Action.parseList(data.actions)},Obj.load=function(s){if(void 0==s||s.length<1)return[];for(var objects=[],objDefs=s.split(","),i=0;i<objDefs.length;i++){var id=objDefs[i].trim(),obj=new Obj(id);aoidos.loader.loadObjectData(id,obj),objects.push(obj)}return objects},Obj.loaded=[],Obj}(),Parser=function(){function Parser(){}return Parser.parse=function(cmd){for(var words=cmd.split(" "),i=0;i<words.length;i++)words[i]=words[i].trim().toLowerCase();for(var tWords=[],i=0;i<words.length;i++)-1==Parser.meaningless.indexOf(words[i])&&tWords.push(words[i]);words=tWords;for(var actions=[],i=0;i<words.length;i++){var found=Room.current.findActions(words[i]);found.length>0&&actions.push(found)}for(var temp,i=1;i<actions.length;i++){if(1==actions[i-1].length){actions[i-1][0].run();break}temp=[];for(var j=0;j<actions[i].length;j++)-1!=actions[i-1].indexOf(actions[i][j])&&temp.push(actions[i][j]);actions[i]=temp}1==actions[actions.length-1].length&&actions[actions.length-1][0].run()},Parser.meaningless=["a","the","to","on"],Parser}(),Room=function(){function Room(id){void 0==Room.current&&(Room.current=this),this.name=this.description=this.inspectText="",this.soundUrls=[],this.firstVisit=!0,this.id=id}return Room.prototype.enter=function(){if(Room.current.unload(),Room.current=this,void 0!==this.bgUrl&&this.bgUrl.length>1){var url="url(data/img/"+this.bgUrl,old=$("#bg").css("background-image");"none"==old&&(old=url),$("body").css("background-image",old),$("#bg").fadeOut(function(){$("#bg").css("background-image",url),$("#bg").fadeIn()})}this.firstVisit?(this.printInspect(),this.firstVisit=!1):this.printDescription()},Room.prototype.printInspect=function(){this.inspectText&&this.inspectText.length>0?aoidos.terminal.printlns(this.inspectText):aoidos.terminal.printlns(this.description)},Room.prototype.printDescription=function(){this.description&&this.description.length>0?aoidos.terminal.printlns(this.description):aoidos.terminal.printlns(this.inspectText)},Room.prototype.parseData=function(data){this.name=data.name,this.soundUrls=data.sound,this.description=data.description,this.inspectText=data.inspect,this.objects=Obj.load(data.objects),this.bgUrl=data.background;var self=this;aoidos.loader.load("rooms/"+this.id+"/lines.json",function(data){self.lines=new Lines(data),self.enter()}),Room.loaded.push(this)},Room.prototype.findActions=function(act){for(var actions=[],i=0;i<this.objects.length;i++){var matches=this.objects[i].findAction(act);void 0!==matches&&(actions=actions.concat(matches))}return actions},Room.prototype.unload=function(){aoidos.terminal.cls()},Room.prototype.getObjPath=function(id){return this.getPath()+"objects/"+id+".json"},Room.prototype.getNPCPath=function(id){return this.getPath()+"npcs/"+id+".json"},Room.prototype.getPath=function(){return"rooms/"+this.id+"/"},Room.isLoaded=function(id){for(var i=0;i<Room.loaded.length;i++)if(Room.loaded[i].id==id)return i;return-1},Room.load=function(id){console.log("--------------------"),console.log("Load Room: "+id),console.log("--------------------");var index=Room.isLoaded(id);-1!=index?Room.loaded[index].enter():aoidos.loader.loadRoomData(id,new Room(id))},Room.loaded=[],Room}(),Sound=function(){function Sound(){console.log("Aoidos: Sound module loaded")}return Sound.prototype.play=function(url){$("#clip").remove(),$("#audioHolder").append('<audio id="clip" src="data/sound/'+url+'"></audio>'),$("#clip").get(0).play()},Sound.play=function(url){aoidos.sound.play(url)},Sound}(),Terminal=function(){function Terminal(){this.history=[""],this.cmdPointer=0,this.lineHolder=$("#lines"),this.cls(),console.log("Aoidos: Prepared Terminal")}return Terminal.prototype.cls=function(currentLine){this.lineHolder.contents().remove(),this.newLine()},Terminal.prototype.print=function(s){this.currentLine.append(s.replace(/[\r\n]/g,"")),this.currentLine.append(this.userInput)},Terminal.prototype.println=function(s){this.print(s),this.newLine()},Terminal.prototype.printlns=function(s){for(var _i=0,lines_1=(s=s.replace(/\[(.+?)\]/g,function($0,$1){return void 0!=Room.current.lines?Room.current.lines.get($1):""})).split("\n");_i<lines_1.length;_i++){var line=lines_1[_i];this.println(line)}},Terminal.prototype.commandTyped=function(){var command=this.userInput.text().trim();this.newLine(),Parser.parse(command),this.history[0]!==command&&this.history.splice(1,0,command),this.history.length>50&&this.history.pop()},Terminal.prototype.cycleHistory=function(direction){this.cmdPointer+=direction.startsWith("D")?-1:1,(this.cmdPointer<0||this.cmdPointer>=this.history.length)&&(this.cmdPointer=0),this.userInput.html(this.history[this.cmdPointer])},Terminal.prototype.newLine=function(){$(".currentLine").removeClass("currentLine").append("&nbsp;"),this.lineHolder.append('<div class="currentLine line"></div>'),this.currentLine=$(".currentLine"),$(".lineMarker").fadeOut(400,function(){$(this).remove()}),this.currentLine.prepend('<div class="lineMarker">&gt;</div>'),$(".userinput").removeAttr("contenteditable").removeClass("current").unbind("keydown"),this.currentLine.append('<div spellcheck="false" contenteditable="true" class="userinput current"></div>'),this.userInput=$(".userinput.current"),this.userInput.click(),setTimeout(function(){aoidos.terminal.userInput.focus()},50),this.currentLine.click(function(){setTimeout(function(){aoidos.terminal.userInput.focus()},50)}),this.currentLine.get(0).scrollIntoView(!1),this.cmdPointer=0,$(".line").length>50&&$(".line").first().remove(),this.userInput.keydown(function(event){switch(event.keyCode){case 13:aoidos.terminal.commandTyped();break;case 27:aoidos.terminal.userInput.html("");break;case 38:aoidos.terminal.cycleHistory("UP");break;case 40:aoidos.terminal.cycleHistory("DOWN")}})},Terminal}(),Trigger=function(){function Trigger(trigger){this.stringDesc=trigger}return Trigger.prototype.trigger=function(){console.log("- Trigger: "+this.stringDesc);var register=this.stringDesc.substr(0,1).toUpperCase(),variables=this.stringDesc.substr(1).replace(/[()]/g,"");switch(register){case"S":this.playSound(variables);break;case"V":this.changeVar(variables.split(",")[0].trim(),variables.split(",")[1].trim());break;case"Q":this.changeQuest(variables.split(",")[0].trim(),variables.split(",")[1].trim());break;case"F":this.executeFunction(variables);break;case"R":this.changeRoom(variables);break;default:console.log("! - Unrecognized Trigger!")}},Trigger.prototype.changeRoom=function(name){Room.load(name)},Trigger.prototype.executeFunction=function(name){console.log("- - Execute Function: "+name),aoidos_custom[name]()},Trigger.prototype.changeQuest=function(name,stage){console.log("- - Change quest: "+name+" set to stage: "+stage),aoidos.quest.set(name,Number(stage))},Trigger.prototype.changeVar=function(name,operation){switch(console.log("- - Change var: "+name+" with op: "+operation),operation.substr(0,1)){case"+":aoidos.var.add(name,Number(operation.substring(1)));break;case"-":aoidos.var.subtract(name,Number(operation.substring(1)));break;default:aoidos.var.set(name,Number(operation))}},Trigger.prototype.playSound=function(variables){console.log("- - Playing sound: "+variables),aoidos.sound.play(variables)},Trigger.parseList=function(data){for(var triggers=[],i=0;i<data.length;i++)triggers.push(new Trigger(data[i]));return triggers},Trigger}(),Var=function(){function Var(){this.vars=[new V]}return Var.prototype.get=function(name){var v=this.find(name);return void 0==v?0:v.qty},Var.prototype.set=function(name,qty){var v=this.find(name);void 0!=v?v.qty=qty:this.vars.push(new V(name,qty))},Var.prototype.add=function(name,qty){this.set(name,this.get(name)+qty)},Var.prototype.subtract=function(name,qty){this.set(name,this.get(name)-qty)},Var.prototype.equals=function(name,qty){return this.get(name)==qty},Var.prototype.smallerThan=function(name,qty){return this.get(name)<qty},Var.prototype.greaterThan=function(name,qty){return this.get(name)>qty},Var.prototype.find=function(name){for(var max=this.vars.length,i=0;i<max;i++)if(this.vars[i].name==name)return this.vars[i]},Var}(),V=function(){return function(name,qty){void 0===name&&(name="none"),void 0===qty&&(qty=0),this.name="",this.qty=0,this.name=name,this.qty=qty}}();